<Query Kind="Program">
  <Reference Relative="..\bin\Debug\net8.0\TestApp.dll">..\bin\Debug\net8.0\TestApp.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\TestApp.deps.json">..\bin\Debug\net8.0\TestApp.deps.json</Reference>
  <Reference Relative="..\bin\Debug\net8.0\TestApp.runtimeconfig.json">..\bin\Debug\net8.0\TestApp.runtimeconfig.json</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Jobs.Abstractions.dll">..\bin\Debug\net8.0\Rhetos.Jobs.Abstractions.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Jobs.Hangfire.dll">..\bin\Debug\net8.0\Rhetos.Jobs.Hangfire.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Autofac.dll">..\bin\Debug\net8.0\Autofac.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\EntityFramework.dll">..\bin\Debug\net8.0\EntityFramework.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\EntityFramework.SqlServer.dll">..\bin\Debug\net8.0\EntityFramework.SqlServer.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Microsoft.CodeAnalysis.CSharp.dll">..\bin\Debug\net8.0\Microsoft.CodeAnalysis.CSharp.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Microsoft.CodeAnalysis.dll">..\bin\Debug\net8.0\Microsoft.CodeAnalysis.dll</Reference>
  <Reference>..\Microsoft.Win32.SystemEvents.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Newtonsoft.Json.dll">..\bin\Debug\net8.0\Newtonsoft.Json.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\NLog.dll">..\bin\Debug\net8.0\NLog.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Oracle.ManagedDataAccess.dll">..\bin\Debug\net8.0\Oracle.ManagedDataAccess.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Compiler.dll">..\bin\Debug\net8.0\Rhetos.Compiler.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Compiler.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Compiler.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Configuration.Autofac.dll">..\bin\Debug\net8.0\Rhetos.Configuration.Autofac.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.DefaultConcepts.dll">..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.DefaultConcepts.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.dll">..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.DatabaseGenerator.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Deployment.dll">..\bin\Debug\net8.0\Rhetos.Deployment.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Deployment.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Deployment.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dom.DefaultConcepts.dll">..\bin\Debug\net8.0\Rhetos.Dom.DefaultConcepts.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dom.DefaultConcepts.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Dom.DefaultConcepts.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dom.dll">..\bin\Debug\net8.0\Rhetos.Dom.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dom.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Dom.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dsl.DefaultConcepts.dll">..\bin\Debug\net8.0\Rhetos.Dsl.DefaultConcepts.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dsl.dll">..\bin\Debug\net8.0\Rhetos.Dsl.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dsl.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Dsl.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Dsl.Parser.dll">..\bin\Debug\net8.0\Rhetos.Dsl.Parser.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Extensibility.dll">..\bin\Debug\net8.0\Rhetos.Extensibility.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Extensibility.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Extensibility.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Host.Net.dll">..\bin\Debug\net8.0\Rhetos.Host.Net.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Logging.dll">..\bin\Debug\net8.0\Rhetos.Logging.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Logging.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Logging.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Persistence.dll">..\bin\Debug\net8.0\Rhetos.Persistence.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Persistence.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Persistence.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Processing.DefaultCommands.dll">..\bin\Debug\net8.0\Rhetos.Processing.DefaultCommands.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Processing.DefaultCommands.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Processing.DefaultCommands.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Processing.dll">..\bin\Debug\net8.0\Rhetos.Processing.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Processing.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Processing.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Security.dll">..\bin\Debug\net8.0\Rhetos.Security.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Security.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Security.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Utilities.dll">..\bin\Debug\net8.0\Rhetos.Utilities.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.Utilities.Interfaces.dll">..\bin\Debug\net8.0\Rhetos.Utilities.Interfaces.dll</Reference>
  <Reference Relative="..\bin\Debug\net8.0\Rhetos.XmlSerialization.dll">..\bin\Debug\net8.0\Rhetos.XmlSerialization.dll</Reference>
  <Namespace>Autofac</Namespace>
  <Namespace>Oracle.ManagedDataAccess.Client</Namespace>
  <Namespace>Rhetos</Namespace>
  <Namespace>Rhetos.Configuration.Autofac</Namespace>
  <Namespace>Rhetos.Dom</Namespace>
  <Namespace>Rhetos.Dom.DefaultConcepts</Namespace>
  <Namespace>Rhetos.Dsl</Namespace>
  <Namespace>Rhetos.Dsl.DefaultConcepts</Namespace>
  <Namespace>Rhetos.Logging</Namespace>
  <Namespace>Rhetos.Persistence</Namespace>
  <Namespace>Rhetos.Security</Namespace>
  <Namespace>Rhetos.Utilities</Namespace>
  <Namespace>System.Data.Entity</Namespace>
  <Namespace>System.DirectoryServices</Namespace>
  <Namespace>System.Runtime.Serialization.Json</Namespace>
  <Namespace>System.Xml.Serialization</Namespace>
  <Namespace>Hangfire</Namespace>
  <Namespace>Rhetos.Jobs</Namespace>
  <Namespace>Rhetos.Jobs.Hangfire</Namespace>
</Query>


// ISSUE: Sometimes the LINQPad process needs to be restared to avoid exception:
//[Error] RhetosJobs: ExecuteJob exception: Autofac.Core.Registration.ComponentNotRegisteredException: The requested service 'TestJobExecuter' has not been registered. To avoid this exception, either register a component to provide the service, check for service registration using IsRegistered(), or use the ResolveOptional() method to resolve an optional dependency.
//   at Autofac.ResolutionExtensions.ResolveService(IComponentContext context, Service service, IEnumerable`1 parameters) in /_/src/Autofac/ResolutionExtensions.cs:line 878
//   at Autofac.ResolutionExtensions.Resolve(IComponentContext context, Type serviceType, IEnumerable`1 parameters) in /_/src/Autofac/ResolutionExtensions.cs:line 342
//   at Autofac.ResolutionExtensions.Resolve[TService](IComponentContext context, IEnumerable`1 parameters) in /_/src/Autofac/ResolutionExtensions.cs:line 294
//   at Autofac.ResolutionExtensions.Resolve[TService](IComponentContext context) in /_/src/Autofac/ResolutionExtensions.cs:line 277
//   at Rhetos.UnitOfWorkScope.Resolve[T]()
//   at Rhetos.Jobs.Hangfire.RhetosExecutionContext`2.ExecuteUnitOfWork(JobParameter`1 job)

void Main()
{
	ConsoleLogger.MinLevel = EventType.Trace; // Use EventType.Trace for more detailed log.
	string rhetosAppPath = Path.Combine(Path.GetDirectoryName(Util.CurrentQueryPath), @"..\bin\debug\net8.0\TestApp.dll");
	using (var rhetosHost = RhetosHost.CreateFrom(rhetosAppPath, ConfigureRhetosHost))
	{
		// Testing if application and database work:
		using (var scope = rhetosHost.CreateScope(cb => cb.RegisterType<ProcessUserInfo>().As<IUserInfo>()))
		{
			scope.Resolve<IUserInfo>().Report().Dump();
			scope.Resolve<Common.DomRepository>().Common.Claim.Query().Count().Dump();
		}

		// Create Hangfire jobs server:
		GlobalConfiguration.Configuration.UseAutofacActivator(rhetosHost.GetRootContainer());
		var rhetosJobServerFactory = rhetosHost.GetRootContainer().Resolve<RhetosJobServerFactory>();
		using (var hangfireJobServer = rhetosJobServerFactory.CreateHangfireJobServer())
		{
			Console.WriteLine("Running a Hangfire job server.");
			
			Test(rhetosHost, hangfireJobServer);
			//Test2(rhetosHost, hangfireJobServer); // Do not run after Test(). Not compatible.

			Console.WriteLine("Stopping the Hangfire job server.");
			Log("===========  Stopping the Hangfire job server ===========");
		}
		Log("===========  HANGFIRE JOB SERVER DISPOSED ===========");
	}
	Log("===========  RHETOS HOST DISPOSED ===========");
}

private static void ConfigureRhetosHost(IRhetosHostBuilder rhetosHostBuilder)
{
	rhetosHostBuilder
		.UseBuilderLogProvider(new ConsoleLogProvider())
		.ConfigureContainer(containerBuilder =>
		{
			// Console:
			containerBuilder.RegisterType<ProcessUserInfo>().As<IUserInfo>();
			containerBuilder.RegisterType<ConsoleLogProvider>().As<ILogProvider>();
			// Test job executer:
			containerBuilder.RegisterType<TestJobExecuter>();
		});
}

class TestJobExecuter : IJobExecuter<object>
{
	public void Execute(object parameter)
	{
		Log($"[TestJobExecuter] {parameter.GetType()} {parameter}");
		if (parameter is long ms)
			Thread.Sleep((int)ms);
		else
			Thread.Sleep(1000);
		Log($"[TestJobExecuter DONE] {parameter.GetType()} {parameter}");
	}
}

public static void Log(string message)
{
	Console.WriteLine($"{DateTime.Now:o} {message}");
}

void Test2(RhetosHost rhetosHost, BackgroundJobServer hangfireJobServer)
{
	using (var scope = rhetosHost.CreateScope())
	{
		var backgroundJobs = scope.Resolve<IBackgroundJobs>();
		Log("===========  ADD JOB ===========");
		backgroundJobs.AddJob<TestJobExecuter, object>(20_000, false, null, null);
		scope.CommitAndClose();
	}
	Log("===========  SCOPE DISPOSED ===========");
	Thread.Sleep(100); // Wait enough for job to start, but not to finish.

	Log("===========  HANGFIRE JOB SERVER DISPOSING ===========");

	// Expected:
	// Disposing of hangfireJobServer in Main() should take 15 seconds waiting for this job to complete
	// see RhetosJobHangfireOptions.ShutdownTimeout.
	// After that, and after rhetosHost is disposed in Main(), this job should run for 5 more seconds,
	// then report an error in LINQPad output when trying to complete the transaction (UnitOfWorkScope.CommitAndClose)
	// because the lifetime scope has already been disposed.
}

void Test(RhetosHost rhetosHost, BackgroundJobServer hangfireJobServer)
{
	Log("===========  INITIAL STATE ===========");
	
	rhetosHost.ReportHangfireDatabaseJobs(-1).Dump("Existing jobs");
	long lastJobId = rhetosHost.GetHangfireDatabaseLastJobId();
	Log($"lastJobId: {lastJobId}");
	
	Log("===========  ADD JOBS ===========");

	using (var scope = rhetosHost.CreateScope())
	{
		var backgroundJobs = scope.Resolve<IBackgroundJobs>();

		for (int i = 0; i < 5; i++) // By default 2 runs in parallel for each background server, see RhetosJobHangfireOptions.WorkerCount.
			backgroundJobs.AddJob<TestJobExecuter, object>(i.ToString(), false, null, null);

		scope.CommitAndClose();
	}

	Thread.Sleep(100); // Wait enough for some jobs to start, but not to finish.

	rhetosHost.ReportHangfireDatabaseJobs(lastJobId).Dump("Initially started jobs"); // Expected: 2 processing (default worker count), 3 pending.

	Log("===========  STOPPING ===========");
	
	hangfireJobServer.SendStop();
	hangfireJobServer.Dispose(); // Waits some time for running jobs to finish.

	rhetosHost.ReportHangfireDatabaseJobs(lastJobId).Dump("After waiting for job server to stop"); // Expected: 2 completed, 3 pending.

	Log("===========  STOPPED ===========");

	Thread.Sleep(10000);

	Log("===========  ADD JOB ===========");

	using (var scope = rhetosHost.CreateScope())
	{
		var backgroundJobs = scope.Resolve<IBackgroundJobs>();

		backgroundJobs.AddJob<TestJobExecuter, object>(123, false, null, null);

		scope.CommitAndClose();
	}

	Thread.Sleep(10000);

	rhetosHost.ReportHangfireDatabaseJobs(lastJobId).Dump("New job added. Background workers still stopped."); // Expected: 2 completed, 4 pending.

	Log("===========  RESTARTING ===========");

	var jobServerFactory = rhetosHost.GetRootContainer().Resolve<RhetosJobServerFactory>();
	using (var jobServer2 = jobServerFactory.CreateHangfireJobServer())
	{
		Thread.Sleep(10000);

		rhetosHost.ReportHangfireDatabaseJobs(lastJobId).Dump("Background workers restarted."); // Expected: 6 completed.
	}

	Log("===========  DONE ===========");
}

static class RhetosHostExtensions
{
	public static long GetHangfireDatabaseLastJobId(this RhetosHost rhetosHost)
	{
		using (var scope = rhetosHost.CreateScope())
		{
			string sql = "SELECT MAX(Id) FROM HangFire.Job WITH (nolock)";
			long lastJobId = 0;
			var sqlExecuter = scope.Resolve<ISqlExecuter>();
			sqlExecuter.ExecuteReader(sql, reader => lastJobId = reader.IsDBNull(0) ? 0 : reader.GetInt64(0));
			return lastJobId;
		}
	}

	public static List<object> ReportHangfireDatabaseJobs(this RhetosHost rhetosHost, long lastJobId)
	{
		using (var scope = rhetosHost.CreateScope())
		{
			string sql = $"SELECT StateName, COUNT(*) FROM HangFire.Job WITH (nolock) WHERE Id > {lastJobId} GROUP BY StateName";
			var report = new List<object>();
			var sqlExecuter = scope.Resolve<ISqlExecuter>();
			sqlExecuter.ExecuteReader(sql,
				reader => report.Add(new
				{
					StateName = reader.GetString(0),
					Count = reader.GetInt32(1)
				}));
			return report;
		}
	}
}
